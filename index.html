<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NYC Housing Insights</title>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark navbar-custom shadow-sm sticky-top fixed-top">
  <div class="container">
    <a class="navbar-brand" href="#top">NY Housing Insights</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="#top">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="#curr_housing">Current Housing Market</a></li>
        <li class="nav-item"><a class="nav-link" href="#national-housing">National Overview</a></li>
        <li class="nav-item"><a class="nav-link" href="#statewide-housing">Statewide Insights</a></li>
        <li class="nav-item"><a class="nav-link" href="#manhattan-housing">Manhattan Focus</a></li>
      </ul>
    </div>
  </div>
</nav>


<main class="container pb-5">

  <section id="top" class="hero-section mb-4 mt-4">
    <div class="hero-content py-5 px-4 px-lg-5 text-center text-lg-start">
      <h1 class="display-4 fw-bold mb-3">The NYC Housing Market</h1>
      <p class="hero-tagline lead">Interactive maps, metrics and analysis to help you find out, will anyone ever be able to afford to live in NYC?</p>
    </div>
  </section>

  <section id="curr_housing" class="mb-4">
    <h2 class="mb-3">Map of the Housing Market in New York</h2>
    <div class="curr-housing-controls">
      <label for="housing-type-filter" class="form-label mb-0">Property Type</label>
      <select id="housing-type-filter" class="form-select form-select-sm"></select>
      <button type="button" id="housing-reset" class="btn btn-outline-secondary btn-sm">Reset</button>
    </div>
    <div class="curr-housing-legend" id="housing-legend"></div>
    <div class="curr-housing-grid">
      <div class="curr-housing-row">
        <div class="curr-housing-row__col">
          <div class="card shadow-sm h-100 curr-housing-card">
            <div class="card-header bg-white border-0 text-center">
              <h3 class="h6 mb-0">Statewide Housing Overview</h3>
            </div>
            <div class="card-body">
              <div id="ny_state_map" class="viz-panel"></div>
            </div>
          </div>
        </div>
        <div class="curr-housing-row__col">
          <div class="card shadow-sm h-100 curr-housing-card">
            <div class="card-header bg-white border-0 text-center">
              <h3 class="h6 mb-0">Explanation of Houses</h3>
            </div>
            <div class="card-body">
              <div id="housing-summary" class="housing-summary text-muted">
                <p class="mb-0">Select a property type to see analysis.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="national-housing" class="col-12 col-lg-10 mx-auto mb-4">
    <div class="card shadow-sm">
      <div class="card-header bg-white border-0 text-center">
        <h2 class="h5 mb-0">Homework Week 10: Nationwide Housing Price Index Increase Relative to Q1 1980<br>
          Comparing NY Housing Price Increase overtime to other States in the US, is NY really the most expensive state to buy a house? Has it been overtime?
        </h2>
      </div>
      <div class="card-body">
        <p class="text-muted text-center mb-3">
          Choropleth map showing Housing Price Index in reference to Q1 1980 with a value of 100.<br>
          Example: NY's Q1 2025 value of 1094.0 indicates that the price for the same house has risen 10.94x since then.
        </p>
        <div id="us_map" class="viz-panel"></div>
        <p>Data up to 2025 Q2</p>
      </div>
    </div>
  </section>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
  (function () {
    const propertyTypes = [
      { value: 'Co-op for sale', label: 'Co-op for sale' },
      { value: 'Coming Soon', label: 'Coming Soon' },
      { value: 'Condo for sale', label: 'Condo for sale' },
      { value: 'Condop for sale', label: 'Condop for sale' },
      { value: 'Contingent', label: 'Contingent' },
      { value: 'For sale', label: 'For sale' },
      { value: 'Foreclosure', label: 'Foreclosure' },
      { value: 'House for sale', label: 'House for sale' },
      { value: 'Land for sale', label: 'Land for sale' },
      { value: 'Mobile house for sale', label: 'Mobile house for sale' },
      { value: 'Multi-family home for sale', label: 'Multi-family home for sale' },
      { value: 'Pending', label: 'Pending' },
      { value: 'Townhouse for sale', label: 'Townhouse for sale' }
    ];

    const propertyColors = {
      'Co-op for sale': '#4e79a7',
      'Coming Soon': '#f28e2b',
      'Condo for sale': '#e15759',
      'Condop for sale': '#76b7b2',
      'Contingent': '#59a14f',
      'For sale': '#edc948',
      'Foreclosure': '#b07aa1',
      'House for sale': '#ff9da7',
      'Land for sale': '#9c755f',
      'Mobile house for sale': '#bab0ab',
      'Multi-family home for sale': '#8cd17d',
      'Pending': '#499894',
      'Townhouse for sale': '#d37295'
    };

    const propertyDefinitions = {
      'Co-op for sale': 'Typically an apartment in a cooperative building where buyers purchase shares in the co-op corporation rather than the unit itself.',
      'Coming Soon': 'Homes scheduled to hit the market shortly; listings are announced early to build interest before official showings begin.',
      'Condo for sale': 'Individually owned units within a larger building or community that include shared common areas and amenities.',
      'Condop for sale': 'Hybrid property combining condo ownership with co-op style governance—often a condo building that contains a co-op component.',
      'Contingent': 'A property under contract where the sale depends on specific conditions being met, such as financing approval or inspection results.',
      'For sale': 'Traditional active listings currently being marketed without special status or contingencies.',
      'Foreclosure': 'Homes in the process of bank repossession due to unpaid mortgage obligations, often sold as-is.',
      'House for sale': 'Stand-alone single-family residences with private entrances and land ownership.',
      'Land for sale': 'Parcels of undeveloped or vacant land available for new construction or investment.',
      'Mobile house for sale': 'Factory-built manufactured homes designed for relocation and typically sited in mobile or manufactured home communities.',
      'Multi-family home for sale': 'Properties containing multiple separate living units within one building, such as duplexes or small apartment structures.',
      'Pending': 'Listings that have an accepted offer and are moving through closing, with minimal chance of returning to market.',
      'Townhouse for sale': 'Multi-level residences sharing one or more walls with neighboring homes, often part of planned communities with shared amenities.'
    };

    const filterSelect = document.getElementById('housing-type-filter');
    const resetButton = document.getElementById('housing-reset');
    const legendContainer = document.getElementById('housing-legend');
    const summaryContainer = document.getElementById('housing-summary');
    let housingData = null;

    if (!filterSelect || !legendContainer || !summaryContainer) {
      return;
    }

    const placeholderOption = document.createElement('option');
    placeholderOption.value = '';
    placeholderOption.textContent = 'Select property type';
    placeholderOption.disabled = true;
    placeholderOption.selected = true;
    filterSelect.append(placeholderOption);
    filterSelect.value = '';

    propertyTypes.forEach(({ value, label }) => {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = label;
      filterSelect.append(option);
    });

    const legendItems = [];
    let views = [];

    const currencyFormat = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      maximumFractionDigits: 0
    });

    const numberFormat = new Intl.NumberFormat('en-US', {
      maximumFractionDigits: 0
    });

    function updateLegend(selected) {
      legendItems.forEach(({ type, element }) => {
        const shouldDim = !!selected && selected !== type;
        element.classList.toggle('is-dimmed', shouldDim);
      });
    }

    function computeSummary(selection) {
      if (!selection || !housingData) {
        return null;
      }
      const records = housingData.filter((row) => row.TYPE === selection);
      if (!records.length) {
        return null;
      }

      const avgPrice =
        records.reduce((total, row) => total + row.PRICE, 0) / records.length;

      const sqftValues = records
        .map((row) => row.SQFT)
        .filter((value) => typeof value === 'number');
      const avgSqft =
        sqftValues.length > 0
          ? sqftValues.reduce((total, value) => total + value, 0) / sqftValues.length
          : null;

      const subCounts = new Map();
      records.forEach((row) => {
        const key = row.SUBLOCALITY || 'Not specified';
        subCounts.set(key, (subCounts.get(key) || 0) + 1);
      });
      const topSub = Array.from(subCounts.entries()).sort((a, b) => {
        if (b[1] === a[1]) {
          return a[0].localeCompare(b[0]);
        }
        return b[1] - a[1];
      })[0];

      const highest = records.reduce((max, row) =>
        row.PRICE > max.PRICE ? row : max
      );

      return {
        avgPrice,
        avgSqft,
        topSubLocality: topSub ? topSub[0] : 'Not specified',
        highest
      };
    }

    function renderSummary(selection) {
      if (!selection) {
        summaryContainer.innerHTML =
          '<p class="mb-0">Select a property type to see analysis.</p>';
        return;
      }
      if (!housingData) {
        summaryContainer.innerHTML =
          '<p class="mb-0">Loading analysis…</p>';
        return;
      }

      const summary = computeSummary(selection);
      if (!summary) {
        summaryContainer.innerHTML =
          '<p class="mb-0">No data available for this property type.</p>';
        return;
      }

      const { avgPrice, avgSqft, topSubLocality, highest } = summary;
      const definition =
        propertyDefinitions[selection] ||
        'Property type description is currently unavailable.';

      summaryContainer.innerHTML = `
        <div class="housing-summary-definition">
          <h4>${selection}</h4>
          <p>${definition}</p>
        </div>
        <div class="housing-summary-grid">
          <div class="housing-summary-card">
            <h4>Average Price</h4>
            <p>${currencyFormat.format(avgPrice)}</p>
          </div>
          <div class="housing-summary-card">
            <h4>Most Common Sublocality</h4>
            <p>${topSubLocality}</p>
          </div>
          <div class="housing-summary-card">
            <h4>Average Area</h4>
            <p>${
              avgSqft ? numberFormat.format(avgSqft) + ' sqft' : 'Not available'
            }</p>
          </div>
          <div class="housing-summary-card">
            <h4>Most Expensive House</h4>
            <p>
              ${currencyFormat.format(highest.PRICE)}
              ${highest.ADDRESS ? `<br><span class="text-muted">${highest.ADDRESS}</span>` : ''}
            </p>
          </div>
        </div>
      `;
    }

    function updateCharts(selection) {
      const trimmed = selection && selection.trim() !== '' ? selection.trim() : '';
      const selectionValue = trimmed || null;
      views.forEach((view) => {
        if (typeof view?.signal === 'function') {
          try {
            view.signal('selectedType', selectionValue).run();
          } catch (_) {
            // Ignore views without the selectedType signal
          }
        }
      });
      updateLegend(trimmed);
      renderSummary(trimmed);
    }

    Object.entries(propertyColors).forEach(([type, color]) => {
      const item = document.createElement('span');
      item.className = 'legend-item';
      item.dataset.type = type;

      const swatch = document.createElement('span');
      swatch.className = 'legend-swatch';
      swatch.style.backgroundColor = color;

      const label = document.createElement('span');
      label.textContent = type;

      item.append(swatch, label);
      legendContainer.append(item);
      legendItems.push({ type, element: item });

      item.addEventListener('click', () => {
        filterSelect.value = type;
        updateCharts(type);
      });
    });

    const chartConfigs = [
      { selector: '#ny_state_map', spec: 'ny_housing.json' },
      { selector: '#manhattan_map', spec: 'manhattan.json' }
    ];

    const embedPromises = chartConfigs.reduce((acc, { selector, spec }) => {
      const container = document.querySelector(selector);
      if (!container) {
        console.warn(`Skipping chart for ${selector} because the container was not found.`);
        return acc;
      }
      const promise = vegaEmbed(container, spec, { actions: false })
        .then((result) => result.view)
        .catch((error) => {
          console.error(`Failed to render chart for ${selector}:`, error);
          return null;
        });
      acc.push(promise);
      return acc;
    }, []);

    Promise.all(embedPromises).then((resultViews) => {
      views = resultViews.filter(Boolean);
      updateCharts(filterSelect.value);
    });

    filterSelect.addEventListener('change', (event) => {
      updateCharts(event.target.value);
    });

    resetButton?.addEventListener('click', () => {
      filterSelect.value = '';
      updateCharts(null);
    });

    updateLegend(filterSelect.value);
    renderSummary(filterSelect.value);

    fetch('data/NY-House-Dataset.csv')
      .then((response) => response.text())
      .then((text) => {
        const rows = vega.read(text, { type: 'csv' });
        housingData = rows
          .map((row) => {
            const price = Number(String(row.PRICE || '').replace(/,/g, ''));
            if (!Number.isFinite(price) || price <= 0) {
              return null;
            }
            const sqftValue = Number(
              String(row.PROPERTYSQFT || '').replace(/,/g, '')
            );
            const sqft =
              Number.isFinite(sqftValue) && sqftValue > 0 ? sqftValue : null;
            return {
              TYPE: row.TYPE || '',
              SUBLOCALITY: row.SUBLOCALITY || 'Not specified',
              PRICE: price,
              SQFT: sqft,
              ADDRESS: row.FORMATTED_ADDRESS || ''
            };
          })
          .filter(Boolean);
        renderSummary(filterSelect.value);
      })
      .catch((error) => {
        console.error('Failed to load housing data for summary panel:', error);
      });
  })();
</script>
<script>
  vegaEmbed('#us_map', 'us_housing.json', { actions: false }).catch(console.error);
</script>
<script>
  const sections = Array.from(document.querySelectorAll('main section[id]'));
  const navLinks = document.querySelectorAll('.navbar .nav-link');

  const setActiveNavLink = () => {
    if (!sections.length) return;

    const offset = window.innerHeight * 0.25;
    let activeId = sections[0].id;

    sections.forEach((section) => {
      const { top } = section.getBoundingClientRect();
      if (top - offset <= 0) {
        activeId = section.id;
      }
    });

    navLinks.forEach((link) => {
      const matches = link.getAttribute('href') === `#${activeId}`;
      link.classList.toggle('active', matches);
    });
  };

  window.addEventListener('scroll', setActiveNavLink, { passive: true });
  window.addEventListener('resize', setActiveNavLink);
  window.addEventListener('load', setActiveNavLink);
  setActiveNavLink();
</script>

</body>
</html>
